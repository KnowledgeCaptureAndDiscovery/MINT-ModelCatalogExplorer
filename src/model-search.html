<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-autocomplete/paper-autocomplete.html">

<link rel="lazy-import" href="model-search.html">
<link rel="lazy-import" href="view-model.html">
<link rel="lazy-import" href="model-configuration.html">
<link rel="lazy-import" href="not-found.html">

<link rel="import" href="/bower_components/app-layout/app-layout.html">
<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="my-icons.html">

<dom-module id="model-search">
  <template>
    <style>
      html, body {
          margin: 0;
          font-family: 'Roboto', 'Noto', sans-serif;
          -webkit-font-smoothing: antialiased;
          max-height: 368px;
        }

        paper-card{
          color: black;
          width: 50%;
          word-wrap: break-word;
          margin: 10px;
        }

        paper-toolbar {
          background-color: #f2f1ed;
          padding: 10px;
        }

        .card-body {
          padding: 10px;
        }

        .card-actions {
          padding: 10px;
        }

        .card-content {
          padding: 10px;
        }

        #search-bar {
          display: flex;
          flex-direction: column;
          width: 50%;
        }

        #search-input {
          width: 1000%;
        }
        #search-icon {
          background-color: #377ff2;
          color: #fff;
        }

        #heading {
          margin-left: 20px;
        }

        #options {
          display: inline-flex;
        }

        #category {
          margin-right: 10px;
        }

        #version {
          margin-left: 10px;
        }

        #results {
          display: flex;
          flex-direction: column;
        }

    </style>

      <div id="content">
        <div id="title">
          <h2>Model Catalog Explorer</h2>
        </div>
        <div id="options">
          <paper-dropdown-menu id="category" label="Select Category">
            <paper-listbox slot="dropdown-content" class="dropdown-content">
              <paper-item>Ecology</paper-item>
              <paper-item>Hydrology</paper-item>
              <paper-item>Economics</paper-item>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-toggle-button id="version" checked>Retrieve latest version</paper-toggle-button>
        </div>
      </div>
      <div id="search-bar">
        <paper-input id="searchInput" value="{{searchParameter}}"></paper-input>
        <paper-autocomplete-suggestions for="searchInput" source="[[accounts]]"></paper-autocomplete-suggestions>
        <paper-icon-button id="searchIcon" icon="icons:search" title="Search" on-click="searchHandler"></paper-icon-button>
      </div>

      <div id="results">
        <dom-repeat items="{{searchResults}}">
        <template>
          <paper-card>
            <div class="card-body">
               <div class="card-content" identity$="{{index}}">
                    <strong>[[item.label]]</strong>
                    <a href="[[item.link]]"><paper-icon-button icon="icons:open-in-new"></paper-icon-button></a>
                    
                    <p>[[item.description]]</p>
                    <paper-icon-button icon="icons:forward" label$="{{item.label}}" model$="{{item.model}}"" on-click="goToModel"></paper-icon-button>
                  </div>
              </div>
            </paper-card>
          </template>
        </dom-repeat>
      </div>
      
      <!-- <paper-button on-click="buttonPress">Fire</paper-button> -->
    <!-- </app-header-layout> -->
  </template>

  <script>
    // Gesture events like tap and track generated from touch will not be
    // preventable, allowing for better scrolling performance.
    Polymer.setPassiveTouchGestures(true);

    class ModelSearch extends Polymer.Element {
      static get is() { return 'model-search'; }
      static get properties() {
        return {
          queries: {
            type: Array,
            value: [],
            observer: "queriesChange"
          },
          searchParameter: String,
          models: Array,
          dummy: Array,
          queriedModels: Array,
          modelSelected: String,
          searchResults: Array,
          results: Array
        };
      }

      queriesChange(newValue, oldValue) {
        console.log(newValue);
        console.log(oldValue);
      }

      goToModel(e) {
        // console.log(e.target);
        var _label = e.target.getAttribute("label");
        var _model = e.target.getAttribute("model");
        var _parent = document.querySelector("mint-explorer-app");

        _parent.modelSelected = {
          model: _model,
          label: _label
        }
        var _pages = Polymer.dom(_parent.root).querySelector("#pages");
        console.log(_pages);
        console.log(_pages.selected);
        _pages.selected = "view-model";
        console.log(_pages.selected);

      }



      searchHandler() {
        var searchString = this.searchParameter;
        var filtered = [];
        for(var i=0; i<this.results.length; ++i) {
          if(this.results[i].label.includes(searchString) || this.results[i].model.includes(searchString) || this.results[i].description.includes(searchString)){
            var obj = JSON.parse(JSON.stringify(this.results[i]));
            filtered.push(obj);
          }
        }
        this.searchResults = filtered;
        console.log(this.searchResults);
      }

      populateSearchResults() {
        var results = [];
        var _parent = document.querySelector("mint-explorer-app");
        var modelDescriptions = _parent.modelDescriptions;
        for(var i = 0; i < this.models.length; ++i) {
          var result = {};
          result.model = this.models[i].model.value;
          result.label = this.models[i].label.value;
          for(var j = 0; j < modelDescriptions.length; ++j) {
            if(modelDescriptions[j].model == this.models[i].model.value) {
              result.description = modelDescriptions[j].description;
              if('link' in modelDescriptions[j]) {
                result.link = modelDescriptions[j].link;
              }
            }
          }
          results.push(result);
        }
        this.results = results;
        this.searchResults = results.slice(0, 2);
      }

      ready() {
        super.ready();
        var _self = this;
        var _parent = document.querySelector("mint-explorer-app");
        console.log(_parent);
        console.log(_parent.queries[0]);
        var query = _parent.queries[0].query;
        // var query = "PREFIX+rdfs%3A+%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0D%0APREFIX+model%3A+%3Chttps%3A%2F%2Fw3id.org%2Fmint%2FmodelCatalog%23%3E%0D%0ASELECT+%3Fmodel+%3Flabel%0D%0AWHERE+%7B%0D%0A++%3Fmodel+a+model%3AModel.%0D%0A++%3Fmodel+rdfs%3Alabel+%3Flabel%0D%0A%7D&format=json";
        var endpoint = _parent.endpoint;
        console.log("Hello", query)
        // var endpoint = "http://ontosoft.isi.edu:3030/ds"
        $.ajax({
            url: endpoint + "/query?query=" + query,
            type: "GET",
            cache: false,
            timeout: 5000,
            async: false,
            complete: function() {
                console.log("GET request sent");
            },

            success: function(data) {
                console.log("GET success");    
                _self.models = data.results.bindings;
                _self.populateSearchResults();
                // _self.searchResults = _self.models;
                console.log(_self.models);           
            },

            error: function(jqXHR, exception) {
                var msg = '';
                if (jqXHR.status === 0) {
                    msg = 'Not connected.\n Verify Network.';
                } 
                else if (jqXHR.status == 404) {
                    msg = 'Requested page not found. [404]';
                } 
                else if (jqXHR.status == 500) {
                    msg = 'Internal Server Error [500].';
                } 
                else if (exception === 'parsererror') {
                    msg = 'Requested JSON parse failed.';
                } 
                else if (exception === 'timeout') {
                    msg = 'Time out error.';
                } 
                else if (exception === 'abort') {
                    msg = 'Ajax request aborted.';
                } 
                else {
                    msg = 'Uncaught Error.\n' + jqXHR.responseText;
                }
                console.log(msg);
            }
        });

        var states = [];
        for(var i = 0; i < this.results.length; ++i) {
          states.push({
            "text": this.results[i].label+" "+this.results[i].description,
            "value": this.results[i].label
          })
        }
 
      var autocompleteSuggestions = Polymer.dom(this.root).querySelector('paper-autocomplete-suggestions');

      autocompleteSuggestions.source = states;

      autocompleteSuggestions.addEventListener('autocomplete-selected', function (event) {
        // var paperToast = document.querySelector('paper-toast');
        // var selected = event.detail.text;
        // paperToast.text = 'Selected: ' + selected;
        // paperToast.show();

        var input = Polymer.dom(_self.root).querySelector("#searchInput");
        input.value = event.detail.value;

      });
      
    }
  }

    window.customElements.define(ModelSearch.is, ModelSearch);
  </script>
</dom-module>
