<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../bower_components/paper-autocomplete-chips/paper-autocomplete-chips.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<!--<link rel="stylesheet" href="../src/css/components.css">-->


<link rel="lazy-import" href="model-search.html">
<link rel="lazy-import" href="view-model.html">
<link rel="lazy-import" href="model-configuration.html">
<link rel="lazy-import" href="not-found.html">

<link rel="import" href="/bower_components/app-layout/app-layout.html">
<link rel="import" href="/bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="/bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="/bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="/bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="/bower_components/paper-input/paper-input.html">
<link rel="import" href="/bower_components/paper-button/paper-button.html">
<link rel="import" href="/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="/bower_components/iron-icons/iron-icons.html">
<link rel="import" href="/bower_components/iron-icon/iron-icon.html">
<link rel="import" href="/bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="/bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="/bower_components/paper-item/paper-item.html">
<link rel="import" href="/bower_components/neon-animation/web-animations.html">
<link rel="import" href="/bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="/bower_components/paper-card/paper-card.html">
<link rel="import" href="my-icons.html">
<link rel="import" href="../bower_components/vaadin-button/vaadin-button.html">
<link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

<dom-module id="model-search">
  <template>
    <style>
      html, body {
          margin: 0;
          font-family: 'Roboto', sans-serif;
          -webkit-font-smoothing: antialiased;
          max-height: 368px;
        }

        paper-card{
          color: black;
          width: 50%;
          word-wrap: break-word;
          margin: 10px;
        }

        paper-input{
          width: 25%;
        }

        paper-button{
          background-color: #eee
        }

        paper-toolbar {
          background-color: #f2f1ed;
          padding: 10px;
        }

        .card-body {
          padding: 15px;
        }

        .card-actions {
          padding: 10px;
        }

        .card-content {
          padding: 10px;
        }

        #search-bar {
          width: 50%;
        }

        #options {
          width: 50%;
        }

        #search-input {
          width: 1000%;
        }
        #searchIcon {
          width: 50%;
        }
        #clearIcon {
          margin-top: -40px;
          margin-left: 51%;
          width: 50%;
        }

        #heading {
          margin-left: 20px;
        }

        #category {
          margin-right: 10px;
          width: 100%
        }

        #version {
          margin-left: 10px;
        }

        #styled{
          width: 35%;
        }
        .primary{
          cursor: pointer;
          border: 1px solid transparent;
          font-size: 14px;
          line-height: 1.846;
          border-radius: 3px;
          -webkit-user-select: none;
          -moz-user-select: none;
          -ms-user-select: none;
          user-select: none;
          color: #ffffff;
          background-color: #2196f3;
        }

        .dropdown-content{
          width: 100%;
        }
        
        .grid {
          margin-left: 20px;
          margin-right: 20px;
          @apply --layout-horizontal;
          @apply --layout-wrap;
          @apply --layout-justified;
          -webkit-flex-basis: 50%;
          flex-basis: 50%;
          max-width: 100%;
        }
        .box {
          @apply --layout-vertical;

          background-color: #FEFEFE;
          border: 1px solid var(--app-accent-color);
          border-radius: 4px;
          background-size: 100% auto;
          background-position: 0px 24px;

          margin: 5px;
          margin-left: 0px;
          min-height: 190px;

          display: block;
          text-decoration: none;
          text-align: center;
          position: relative;
          width: 47.5%;
          padding: 15px;
        }
        .box .inner {
          background: rgba(255,255,255,0.5);
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
        }
        .flex-center-justified {
          @apply --layout-horizontal;
          @apply --layout-center-justified;
        }

        .flex-end-justified {
          margin-right: 40px;
          @apply --layout-horizontal;
          @apply --layout-end-justified;
        }


    </style>

    <div class="container flex-center-justified">
      <div><h1>Model Catalog Explorer</h1></div>
    </div>
    <div class="container flex-center-justified">
      <div id="options">
        <paper-dropdown-menu id="category" label="Select Category">
          <paper-listbox slot="dropdown-content" class="dropdown-content">
            <paper-item>Ecology</paper-item>
            <paper-item>Hydrology</paper-item>
            <paper-item>Economics</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <vaadin-checkbox id="version" checked>Retrieve latest version</vaadin-checkbox>
      </div>
    </div>
    <div class="container flex-center-justified">
      <div id="search-bar">
        <!--<paper-input id="searchInput" label="Search Model Name" value="{{searchParameter}}"></paper-input>-->
        <paper-autocomplete-chips id="searchInput" label="Search Model Name" for="searchInput" source="[[accounts]]">
        </paper-autocomplete-chips>
        <br>
        <div class="grid">
          <vaadin-button theme="contrast primary" id="searchIcon" title="Search" on-click="searchHandler" slot="suffix" prefix icon="search"><iron-icon icon="icons:search" slot="prefix"></iron-icon>Search
          </vaadin-button>
          <vaadin-button theme="error primary" id="clearIcon" title="Clear" on-click="clearHandler" slot="suffix" prefix icon="search"><iron-icon icon="icons:close" slot="prefix"></iron-icon>Clear
          </vaadin-button>
        </div>
      </div>
    </div>
    <br>
    <div class="container flex-end-justified">
      <div><b>Displaying [[numberofRes]]/[[totalRes]] results</b></div>
    </div>
    <br>
    <div class="grid">
      <dom-repeat items="{{tempResults}}">
      <template>
        <div class="box">
         <div class="card-content" identity$="{{index}}">
              <strong>[[item.label]]</strong>
              <a href="[[item.link]]" target="_blank" hidden="[[item.avail]]"><paper-icon-button icon="icons:open-in-new"></paper-icon-button></a>
              
              <p>[[item.description]]</p>
              <a href="[[routePath]]view-model"><vaadin-button theme="primary" label$="{{item.label}}" model$="{{item.model}}" on-click="goToModel" raised>Explore [[item.label]]</vaadin-button ></a>
            </div>
        </div>
        </template>
      </dom-repeat>
    </div>
      
      <!-- <paper-button on-click="buttonPress">Fire</paper-button> -->
    <!-- </app-header-layout> -->
  </template>


  <script>
    // Gesture events like tap and track generated from touch will not be
    // preventable, allowing for better scrolling performance.
    Polymer.setPassiveTouchGestures(true);

    class ModelSearch extends Polymer.Element {
      static get is() { return 'model-search'; }
      static get properties() {
        return {
          queries: {
            type: Array,
            value: [],
            observer: "queriesChange"
          },
          searchParameter: String,
          models: Array,
          dummy: Array,
          queriedModels: Array,
          modelSelected: String,
          searchResults: Array,
          tempResults: Array,
          numberofRes: String,
          totalRes: String,
          results: Array
        };
      }

      queriesChange(newValue, oldValue) {
        console.log(newValue);
        console.log(oldValue);
      }

      goToModel(e) {
        // console.log(e.target);
        var _label = e.target.getAttribute("label");
        var _model = e.target.getAttribute("model");
        var _parent = document.querySelector("mint-explorer-app");

        _parent.modelSelected = {
          model: _model,
          label: _label
        }
        var _pages = Polymer.dom(_parent.root).querySelector("#pages");
        console.log(_pages);
        console.log(_pages.selected);
        _pages.selected = "view-model";
        //this.set('route.path', '/view-model');
        console.log(_pages.selected);

      }

      searchHandler() {
        var searchString = Polymer.dom(this.root).querySelector("#searchInput").value;
        console.log(searchString)
        var filtered = [];
        for(var i=0; i<this.results.length; ++i) {
          if(this.results[i].label.includes(searchString) || this.results[i].model.includes(searchString) || this.results[i].description.includes(searchString)){
            var obj = JSON.parse(JSON.stringify(this.results[i]));
            filtered.push(obj);
          }
        }
        this.totalRes = this.results.length.toString();
        this.tempResults = filtered;
        this.numberofRes = this.tempResults.length.toString();
        console.log(this.searchResults);
      }

      clearHandler(){
        location.reload();
      }

      populateSearchResults() {
        var results = [];
        var _parent = document.querySelector("mint-explorer-app");
        var modelDescriptions = _parent.modelDescriptions;
        console.log("hfkjdf")
        console.log(modelDescriptions)
        console.log("ddkjfhsjk")
        for(var i = 0; i < this.models.length; ++i) {
          var result = {};
          result.model = this.models[i].model.value;
          result.label = this.models[i].label.value;
          result.avail = false;
          for(var j = 0; j < modelDescriptions.length; ++j) {
            if(modelDescriptions[j].model == this.models[i].model.value) {
              result.description = modelDescriptions[j].description;
              if('link' in modelDescriptions[j]) {
                result.link = modelDescriptions[j].link;
              }
              else{
                result.avail = true;
              }
            }
          }
          results.push(result);
        }
        this.results = results;
        this.totalRes = results.length.toString();
        this.searchResults = results;
        var newArray = results.slice();
        this.tempResults = newArray.splice(0, 10);
        this.numberofRes = this.tempResults.length.toString();
      }

      ready() {
        super.ready();
        var _self = this;
        var _parent = document.querySelector("mint-explorer-app");
        console.log(_parent);
        console.log(_parent.queries[0]);
        var query = _parent.queries[0].query;
        // var query = "PREFIX+rdfs%3A+%3Chttp%3A%2F%2Fwww.w3.org%2F2000%2F01%2Frdf-schema%23%3E%0D%0APREFIX+model%3A+%3Chttps%3A%2F%2Fw3id.org%2Fmint%2FmodelCatalog%23%3E%0D%0ASELECT+%3Fmodel+%3Flabel%0D%0AWHERE+%7B%0D%0A++%3Fmodel+a+model%3AModel.%0D%0A++%3Fmodel+rdfs%3Alabel+%3Flabel%0D%0A%7D&format=json";
        var endpoint = _parent.endpoint;
        console.log("Hello", query)
        // var endpoint = "http://ontosoft.isi.edu:3030/ds"
        $.ajax({
            url: endpoint + "/query?query=" + query,
            type: "GET",
            cache: false,
            timeout: 5000,
            async: false,
            complete: function() {
                console.log("GET request sent");
            },

            success: function(data) {
                console.log("GET success");    
                _self.models = data.results.bindings;
                _self.populateSearchResults();
                // _self.searchResults = _self.models;
                console.log(_self.models);           
            },

            error: function(jqXHR, exception) {
                var msg = '';
                if (jqXHR.status === 0) {
                    msg = 'Not connected.\n Verify Network.';
                } 
                else if (jqXHR.status == 404) {
                    msg = 'Requested page not found. [404]';
                } 
                else if (jqXHR.status == 500) {
                    msg = 'Internal Server Error [500].';
                } 
                else if (exception === 'parsererror') {
                    msg = 'Requested JSON parse failed.';
                } 
                else if (exception === 'timeout') {
                    msg = 'Time out error.';
                } 
                else if (exception === 'abort') {
                    msg = 'Ajax request aborted.';
                } 
                else {
                    msg = 'Uncaught Error.\n' + jqXHR.responseText;
                }
                console.log(msg);
            }
        });

        var states = [];
        var opts = [];
        console.log("Hellop");
        console.log(this.results);
        for(var i = 0; i < this.results.length; ++i) {
          states.push({
            "text": this.results[i].label+" "+this.results[i].description,
            "value": this.results[i].label
          })
          opts.push(this.results[i].label)
        }
        console.log(opts)
 
      var autocompleteSuggestions = Polymer.dom(this.root).querySelector('paper-autocomplete-chips');

      autocompleteSuggestions.source = opts;

      autocompleteSuggestions.addEventListener('autocomplete-selected', function (event) {
        //var paperToast = document.querySelector('paper-toast');
        //var selected = event.detail.text;
        //paperToast.text = 'Selected: ' + selected;
        //paperToast.show();
        var input = Polymer.dom(_self.root).querySelector("#searchInput");
        input.value = event.detail.value;
        console.log(input.value)
      });
      
    }
  }

    window.customElements.define(ModelSearch.is, ModelSearch);
  </script>
</dom-module>
